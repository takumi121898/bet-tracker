<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>スポーツくじ記録アプリ（ローカル保存 / B1チーム選択対応）</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--muted:#8a94a7;--text:#e7ecf3;--accent:#74c0fc;--accent2:#a5d8ff;
      --win:#2f9e44;--lose:#e03131;--push:#f08c00;--card:#151924;--border:#242b3a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP","Meiryo",sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.75));backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:4px 0 12px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:880px){.row{grid-template-columns:repeat(4,1fr)}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0e121a;color:var(--text)}
    textarea{min-height:60px}
    button{appearance:none;border:1px solid var(--border);background:#101523;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1f2638,#182034);border-color:#2a3350}
    button.ghost{background:transparent}
    .btns{display:flex;flex-wrap:wrap;gap:8px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:760px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .k{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .k .v{font-size:20px;font-weight:700}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0d121b;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .tr{display:grid;grid-template-columns:120px 1fr 90px 90px 80px 90px 80px 120px;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
    .th{color:var(--muted);font-size:12px}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;text-align:center}
    .pill.win{background:rgba(47,158,68,.15);color:#a6f4c5;border:1px solid rgba(47,158,68,.35)}
    .pill.lose{background:rgba(224,49,49,.15);color:#ffc9c9;border:1px solid rgba(224,49,49,.35)}
    .pill.push{background:rgba(240,140,0,.15);color:#ffe8a1;border:1px solid rgba(240,140,0,.35)}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tools{display:flex;gap:8px;justify-content:flex-end}
    .danger{border-color:#553;}
    .search{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media (min-width:760px){.search{grid-template-columns:repeat(6,1fr)}}
    .hr{height:1px;background:var(--border);margin:8px 0}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>スポーツくじ記録アプリ <span class="tag">ローカル保存</span></h1>
      <div class="sub">スマホ内のローカルストレージに保存されます（通信不要）</div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:12px">
    <!-- 入力カード -->
    <section class="card">
      <h2 style="margin:0 0 8px">記録を追加</h2>
      <div class="row">
        <div>
          <label>日付</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label>試合（自由入力・自動入力されます）</label>
          <input type="text" id="match" placeholder="例）秋田 vs 群馬" />
        </div>
        <div>
          <label>ホーム（B1）</label>
          <select id="homeTeam"></select>
        </div>
        <div>
          <label>アウェイ（B1）</label>
          <select id="awayTeam"></select>
        </div>
        <div>
          <label>点差（例：+3〜+6 / −1〜0 など）</label>
          <input type="text" id="margin" placeholder="例）+3〜+6" />
        </div>
        <div>
          <label>賭けタイプ（任意：勝敗/点差/合計など）</label>
          <input type="text" id="betType" placeholder="例）点差" />
        </div>
        <div>
          <label>掛け金（円）</label>
          <input type="number" inputmode="decimal" id="stake" placeholder="500" />
        </div>
        <div>
          <label>オッズ</label>
          <input type="number" step="0.01" inputmode="decimal" id="odds" placeholder="2.5" />
        </div>
        <div>
          <label>結果</label>
          <select id="result">
            <option value="win">勝ち</option>
            <option value="lose">負け</option>
            <option value="push">引き分け/プッシュ</option>
            <option value="pending">未決</option>
          </select>
        </div>
        <div>
          <label>払戻（円・任意）</label>
          <input type="number" inputmode="decimal" id="payout" placeholder="未入力なら自動計算可" />
        </div>
      </div>
      <div class="row" style="grid-template-columns:1fr">
        <div>
          <label>メモ（任意）</label>
          <textarea id="note" placeholder="例）3Qで流れが変わった／主力欠場メモなど"></textarea>
        </div>
      </div>
      <div class="btns" style="margin-top:8px">
        <button class="primary" id="add">＋ 記録を追加</button>
        <button id="clearForm" class="ghost">入力クリア</button>
        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="autoPayout" checked /> 勝ちのとき【払戻=掛け金×オッズ】を自動計算
        </label>
      </div>
    </section>

    <!-- 集計カード -->
    <section class="card">
      <h2 style="margin:0 0 8px">集計</h2>
      <div class="kpi">
        <div class="k"><div class="small muted">合計掛け金</div><div class="v" id="k_stake">0</div></div>
        <div class="k"><div class="small muted">総払戻金</div><div class="v" id="k_payout">0</div></div>
        <div class="k"><div class="small muted">収支</div><div class="v" id="k_profit">0</div></div>
        <div class="k"><div class="small muted">ROI（%）</div><div class="v" id="k_roi">0%</div></div>
      </div>
    </section>

    <!-- 検索/フィルタ -->
    <section class="card">
      <h2 style="margin:0 8px 8px 0;display:flex;justify-content:space-between;align-items:center">
        <span>検索・フィルタ</span>
        <span class="btns">
          <button id="exportCsv" class="ghost">CSVエクスポート</button>
          <button id="exportJson" class="ghost">JSONエクスポート</button>
          <button id="importJson" class="ghost">JSONインポート</button>
          <button id="wipeAll" class="ghost danger">全データ削除</button>
        </span>
      </h2>
      <div class="search">
        <div>
          <label>キーワード（試合名・メモ）</label>
          <input type="text" id="q" placeholder="例）秋田 / 群馬 / 点差+3" />
        </div>
        <div>
          <label>結果</label>
          <select id="qResult">
            <option value="">すべて</option>
            <option value="win">勝ち</option>
            <option value="lose">負け</option>
            <option value="push">引き分け/プッシュ</option>
            <option value="pending">未決</option>
          </select>
        </div>
        <div>
          <label>開始日</label>
          <input type="date" id="qFrom" />
        </div>
        <div>
          <label>終了日</label>
          <input type="date" id="qTo" />
        </div>
        <div>
          <label>並び替え</label>
          <select id="qSort">
            <option value="date_desc">日付↓新しい</option>
            <option value="date_asc">日付↑古い</option>
            <option value="profit_desc">利益↓大きい</option>
            <option value="stake_desc">掛け金↓大きい</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button id="apply" class="primary">適用</button>
          <button id="reset" class="ghost">リセット</button>
        </div>
      </div>
    </section>

    <!-- 一覧 -->
    <section class="card">
      <h2 style="margin:0 0 8px">記録一覧 <span class="sub" id="count"></span></h2>
      <div id="list" class="grid" style="gap:8px"></div>
    </section>

  </main>

  <input type="file" id="filePicker" accept="application/json" style="display:none" />

  <script>
    const KEY = 'BET_TRACKER_V1';
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);

    const state = {
      items: [],
      filters: { q:"", result:"", from:"", to:"", sort:"date_desc" }
    };

    // B1チーム（スクショの一覧ベース）
    const TEAMS = {
      east: [
        'レバンガ北海道','仙台89ERS','秋田ノーザンハピネッツ','茨城ロボッツ','宇都宮ブレックス','群馬クレインサンダーズ','越谷アルファーズ','アルティーリ千葉','千葉ジェッツ','アルバルク東京','サンロッカーズ渋谷','横浜ビー・コルセアーズ','川崎ブレイブサンダース'
      ],
      west: [
        '富山グラウジーズ','三遠ネオフェニックス','シーホース三河','ファイティングイーグルス名古屋','名古屋ダイヤモンドドルフィンズ','滋賀レイクス','京都ハンナリーズ','大阪エヴェッサ','島根スサノオマジック','広島ドラゴンフライズ','佐賀バルーナーズ','長崎ヴェルカ','琉球ゴールデンキングス'
      ]
    };

    function load(){
      try{ state.items = JSON.parse(localStorage.getItem(KEY)||'[]'); }
      catch(e){ state.items = []; }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state.items)); }

    function yen(n){ if(isNaN(n)) return '0'; return Number(n).toLocaleString('ja-JP'); }

    function todayIso(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }

    // 初期化
    (function init(){
      load();
      populateTeams();
      $('#date').value = todayIso();
      render();
      bind();
      updateMatchFromTeams();
    })();

    function bind(){
      $('#add').addEventListener('click', onAdd);
      $('#clearForm').addEventListener('click', clearForm);
      $('#apply').addEventListener('click', ()=>{ readFilters(); render(); });
      $('#reset').addEventListener('click', ()=>{ resetFilters(); render(); });
      $('#exportCsv').addEventListener('click', exportCSV);
      $('#exportJson').addEventListener('click', exportJSON);
      $('#importJson').addEventListener('click', ()=> $('#filePicker').click());
      $('#filePicker').addEventListener('change', importJSON);
      $('#wipeAll').addEventListener('click', wipeAll);
      // 追加: チーム選択変更で試合名を自動生成
      $('#homeTeam').addEventListener('change', updateMatchFromTeams);
      $('#awayTeam').addEventListener('change', updateMatchFromTeams);
    }

    function onAdd(){
      const home = $('#homeTeam').value || '';
      const away = $('#awayTeam').value || '';
      if(home && away && home===away){ alert('ホームとアウェイが同じです'); return; }
      const matchText = ($('#match').value.trim() || (home&&away? `${home} vs ${away}` : '')).trim();
      const item = {
        id: Date.now().toString(36)+Math.random().toString(36).slice(2,7),
        date: $('#date').value || todayIso(),
        match: matchText,
        homeTeam: home || null,
        awayTeam: away || null,
        margin: $('#margin').value.trim(),
        betType: $('#betType').value.trim(),
        stake: parseFloat($('#stake').value||0),
        odds: parseFloat($('#odds').value||0),
        result: $('#result').value,
        payout: $('#payout').value? parseFloat($('#payout').value): null,
        note: $('#note').value.trim()
      };
      if($('#autoPayout').checked && item.result==='win' && !item.payout){
        item.payout = +(item.stake * item.odds).toFixed(2);
      }
      if(item.result==='lose' && !item.payout){ item.payout = 0; }
      if(item.result==='push' && !item.payout){ item.payout = item.stake; }
      state.items.unshift(item);
      save();
      clearForm();
      render();
    }

    function clearForm(){
      $('#date').value = todayIso();
      $('#match').value = '';
      $('#homeTeam').value = '';
      $('#awayTeam').value = '';
      $('#margin').value = '';
      $('#betType').value = '';
      $('#stake').value = '';
      $('#odds').value = '';
      $('#result').value = 'win';
      $('#payout').value = '';
      $('#note').value = '';
    }

    function readFilters(){
      state.filters.q = $('#q').value.trim();
      state.filters.result = $('#qResult').value;
      state.filters.from = $('#qFrom').value;
      state.filters.to = $('#qTo').value;
      state.filters.sort = $('#qSort').value;
    }

    function resetFilters(){
      $('#q').value = '';
      $('#qResult').value = '';
      $('#qFrom').value = '';
      $('#qTo').value = '';
      $('#qSort').value = 'date_desc';
      readFilters();
    }

    function filtered(){
      readFilters();
      let arr = [...state.items];
      const {q,result,from,to,sort} = state.filters;
      if(q){ const s=q.toLowerCase(); arr = arr.filter(x=> (x.match||'').toLowerCase().includes(s) || (x.margin||'').toLowerCase().includes(s) || (x.note||'').toLowerCase().includes(s)); }
      if(result){ arr = arr.filter(x=> x.result===result); }
      if(from){ arr = arr.filter(x=> (x.date||'') >= from); }
      if(to){ arr = arr.filter(x=> (x.date||'') <= to); }
      switch(sort){
        case 'date_asc': arr.sort((a,b)=> (a.date>b.date?1:-1)); break;
        case 'profit_desc': arr.sort((a,b)=> (profit(b)-profit(a))); break;
        case 'stake_desc': arr.sort((a,b)=> (b.stake - a.stake)); break;
        default: // date_desc
          arr.sort((a,b)=> (a.date<b.date?1:-1));
      }
      return arr;
    }

    function profit(x){
      const p = (x.payout ?? (x.result==='win'? x.stake*x.odds : x.result==='push'? x.stake : 0)) - x.stake;
      return Math.round(p*100)/100;
    }

    function render(){
      const arr = filtered();
      $('#count').textContent = `${arr.length}件`;
      // 集計
      let stake=0,payout=0;
      arr.forEach(x=>{
        stake += x.stake||0;
        const po = x.payout ?? (x.result==='win'? x.stake*x.odds : x.result==='push'? x.stake : 0);
        payout += po;
      });
      const profitV = payout - stake;
      const roi = stake>0 ? ((payout/stake-1)*100) : 0;
      $('#k_stake').textContent = yen(stake);
      $('#k_payout').textContent = yen(payout);
      $('#k_profit').textContent = `${profitV>=0?'+':''}${yen(Math.round(profitV))}`;
      $('#k_roi').textContent = `${roi.toFixed(1)}%`;

      // 一覧
      const $list = $('#list');
      $list.innerHTML = '';

      // ヘッダ
      const head = h('div',{class:'tr th'},[
        cell('日付'),cell('試合'),cell('掛け金','right'),cell('オッズ','right'),cell('結果'),cell('払戻','right'),cell('損益','right'),cell('点差/タイプ')
      ]);
      $list.append(head);

      arr.forEach(x=>{
        const pillClass = x.result==='win'?'win': x.result==='lose'?'lose': x.result==='push'?'push':'';
        const payoutV = x.payout ?? (x.result==='win'? x.stake*x.odds : x.result==='push'? x.stake : 0);
        const p = profit(x);
        const row = h('div',{class:'tr'},[
          cell(x.date||'-','muted'),
          cell(h('div',{class:'nowrap'},[(x.match || ((x.homeTeam&&x.awayTeam)? `${x.homeTeam} vs ${x.awayTeam}` : '-') )]),''),
          cell(yen(x.stake||0),'right'),
          cell((x.odds||0).toFixed(2),'right'),
          cell(h('span',{class:`pill ${pillClass}`},[labelTxt(x.result)])),
          cell(yen(Math.round(payoutV)),'right'),
          cell((p>=0?'+':'')+yen(Math.round(p)),'right'),
          cell(h('div',{},[
            h('div',{class:'small'},[x.margin||'-']),
            h('div',{class:'small muted'},[x.betType?`タイプ：${x.betType}`:''])
          ]))
        ]);

        // 行末ツール
        const tools = h('div',{class:'tools'},[
          btn('編集',()=> editItem(x.id)),
          btn('削除',()=> delItem(x.id))
        ]);
        row.appendChild(tools);
        $list.append(row);
      });
    }

    function labelTxt(r){
      switch(r){
        case 'win':return '勝ち';
        case 'lose':return '負け';
        case 'push':return '引き分け';
        case 'pending':return '未決';
        default:return r||'-';
      }
    }

    function h(tag,attrs={},children=[]){
      const el=document.createElement(tag);
      for(const k in attrs){ if(k==='class') el.className=attrs[k]; else el.setAttribute(k,attrs[k]); }
      (Array.isArray(children)?children:[children]).forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') el.appendChild(document.createTextNode(c));
        else el.appendChild(c);
      });
      return el;
    }
    function cell(content,extraClass=''){ const d=h('div',{class:extraClass}); if(typeof content==='string') d.textContent=content; else d.appendChild(content); return d; }
    function btn(label,onclick){ const b=h('button',{},[label]); b.addEventListener('click',onclick); return b; }

    function editItem(id){
      const x = state.items.find(v=>v.id===id); if(!x) return;
      // フォームに展開
      $('#date').value = x.date||todayIso();
      $('#match').value = x.match||'';
      $('#homeTeam').value = x.homeTeam||'';
      $('#awayTeam').value = x.awayTeam||'';
      $('#margin').value = x.margin||'';
      $('#betType').value = x.betType||'';
      $('#stake').value = x.stake||'';
      $('#odds').value = x.odds||'';
      $('#result').value = x.result||'win';
      $('#payout').value = (x.payout!=null? x.payout : '');
      $('#note').value = x.note||'';
      // 既存を削除→保存で上書き的に扱う
      state.items = state.items.filter(v=>v.id!==id);
      save();
      render();
    }

    function delItem(id){
      if(!confirm('この記録を削除しますか？')) return;
      state.items = state.items.filter(v=>v.id!==id);
      save();
      render();
    }

    function exportCSV(){
      const arr = filtered();
      const head = ['id','date','match','homeTeam','awayTeam','margin','betType','stake','odds','result','payout','profit','note'];
      const lines = [head.join(',')];
      arr.forEach(x=>{
        const row = [x.id,x.date,(x.match||''),(x.homeTeam||''),(x.awayTeam||''),x.margin,x.betType,x.stake,x.odds,x.result,(x.payout!=null?x.payout:''),profit(x),(x.note||'')]
          .map(v=> {
            if (typeof v === 'string') {
              const s = v.replace(/"/g,'""');
              return s.includes(',') ? `"${s}"` : s;
            }
            return v;
          });
        lines.push(row.join(','));
      });
      const blob = new Blob(["\uFEFF"+lines.join("\n")],{type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bets.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bets.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSON(ev){
      const file = ev.target.files[0];
      if(!file) return; const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!Array.isArray(data)) throw new Error('配列ではありません');
          // 既存に追記（ID重複はスキップ）
          const existed = new Set(state.items.map(x=>x.id));
          data.forEach(x=>{ if(x && x.id && !existed.has(x.id)) state.items.push(x); });
          save(); render(); alert('インポート完了');
        }catch(e){ alert('読み込みに失敗：'+e.message); }
        ev.target.value = '';
      };
      reader.readAsText(file);
    }

    function wipeAll(){
      if(!confirm('本当に全データを削除しますか？（元に戻せません）')) return;
      state.items = []; save(); render();
    }

    // --- 追加: チーム選択を埋める & 自動試合名 ---
    function populateTeams(){
      const home = $('#homeTeam'); const away = $('#awayTeam');
      const make = (sel)=>{
        sel.innerHTML = '<option value=\"\">選択</option>' +
          ['east','west'].map(zone=>{
            const label = zone==='east'?'東地区':'西地区';
            const opts = TEAMS[zone].map(t=>`<option value=\"${t}\">${t}</option>`).join('');
            return `<optgroup label=\"${label}\">${opts}</optgroup>`;
          }).join('');
      };
      make(home); make(away);
    }
    function updateMatchFromTeams(){
      const h = $('#homeTeam').value; const a = $('#awayTeam').value;
      if(h && a){ $('#match').value = `${h} vs ${a}`; }
    }
  </script>
</body>
</html>
